name: Sync Commits to Central

on:
  push:
    branches:
      - main
      - master

jobs:
  sync-commits:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # 최근 50개 커밋만 가져오기

      - name: Get commit metadata
        id: commits
        run: |
          # 최근 50개 커밋 정보 추출
          COMMITS_JSON=$(git log -50 --pretty=format:'{"sha_short":"%h","message":"%s","committed_at":"%aI"},' | sed 's/,$//')
          
          # 커밋 메시지 처리 (1줄만, 최대 120자, 특수문자 이스케이프)
          COMMITS_JSON=$(echo "$COMMITS_JSON" | python3 << 'PYTHON'
          import json
          import sys
          import re
          
          commits_str = sys.stdin.read()
          if commits_str.strip():
              # JSON 배열로 변환
              commits_list = json.loads('[' + commits_str + ']')
              
              # 각 커밋 메시지 처리
              for commit in commits_list:
                  # 첫 줄만 추출 (개행 제거)
                  msg = commit['message'].split('\n')[0]
                  # 최대 120자로 제한
                  msg = msg[:120]
                  # JSON 이스케이프
                  commit['message'] = msg
              
              print(json.dumps(commits_list, ensure_ascii=False))
          else:
              print('[]')
          PYTHON
          )
          
          echo "commits_json<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Owner와 Repo 추출
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"
          KEY="${OWNER}__${REPO}"
          
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Prepare commits.json
        id: prepare
        run: |
          OWNER="${{ steps.commits.outputs.owner }}"
          REPO="${{ steps.commits.outputs.repo }}"
          KEY="${{ steps.commits.outputs.key }}"
          UPDATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # 최종 JSON 생성
          cat > commits.json << EOF
          {
            "owner": "${OWNER}",
            "repo": "${REPO}",
            "updated_at": "${UPDATED_AT}",
            "commits": ${{ steps.commits.outputs.commits_json }}
          }
          EOF
          
          echo "data_dir=site/data/${KEY}" >> $GITHUB_OUTPUT
          cat commits.json

      - name: Push to central repository
        env:
          GITHUB_TOKEN: ${{ secrets.BIG_REPO_TOKEN }}
        run: |
          CENTRAL_REPO="allison-eunse/gene-brain"
          DATA_DIR="${{ steps.prepare.outputs.data_dir }}"
          
          # Clone central repo
          git clone --depth 1 https://${GITHUB_TOKEN}@github.com/${CENTRAL_REPO}.git central-repo
          cd central-repo
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Copy commit data
          mkdir -p "$DATA_DIR"
          cp "../commits.json" "$DATA_DIR/commits.json"
          
          # Commit and push
          git add "$DATA_DIR/commits.json"
          git commit -m "chore: sync commits from ${{ steps.commits.outputs.key }} [skip ci]" || exit 0
          git push
